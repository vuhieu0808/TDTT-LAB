"""
Module tÃ­ch há»£p Google Gemini API Ä‘á»ƒ Ä‘á» xuáº¥t project thá»±c hÃ nh
"""
import os
import json
from google import genai
from typing import List, Dict, Optional
from data_type import *


class AIProjectSuggester:
    """Class Ä‘á»ƒ Ä‘á» xuáº¥t project thá»±c hÃ nh sá»­ dá»¥ng Google Gemini"""
    
    def __init__(self, api_key: Optional[str] = None):
        """
        Khá»Ÿi táº¡o AI Project Suggester vá»›i Google Gemini
        
        Args:
            api_key: Google API key (náº¿u khÃ´ng cung cáº¥p sáº½ láº¥y tá»« GOOGLE_API_KEY env variable)
        """
        self.api_key = api_key or os.getenv("GOOGLE_API_KEY")
        self.client = None
        self.model_name = "gemini-2.5-flash"
        self.SYSTEM_INSTRUCTION = '''
            You are a project advisor AI. Your task is to analyze the provided IT job information and the student's skill set, and suggest relevant projects that can help the student bridge the gap between their current skills and those required for the job.
        '''
        
        if self.api_key:
            self._initialize_client()
    
    def _initialize_client(self):
        """Khá»Ÿi táº¡o Google Gemini client"""
        try:
            self.client = genai.Client(api_key=self.api_key)
        except Exception as e:
            print(f"âŒ Lá»—i khi khá»Ÿi táº¡o Gemini: {e}")
            self.client = None
    
    def _create_prompt(self, job_info: Job, student_knowledge: List[str]) -> str:
        """
        Táº¡o prompt cho LLM theo format cá»§a project_prompt.py
        
        Args:
            job_info: object Job
            student_knowledge: Danh sÃ¡ch knowledge mÃ  student Ä‘Ã£ cÃ³
            
        Returns:
            Prompt string
        """
        
        # Format as JSON strings
        other_names_str = ',\n        '.join([f'"{name}"' for name in job_info.other_name])
        essential_knowledge_str = ',\n        '.join([f'"{k}"' for k in job_info.essential_knowledge])
        optional_knowledge_str = ',\n        '.join([f'"{k}"' for k in job_info.optional_knowledge])
        student_knowledge_str = ',\n    '.join([f'"{k}"' for k in student_knowledge])
        
        prompt = f'''Given the job information: 
{{
    "name": "{job_info.name}",
    "description": "{job_info.description}",
    "other_name": [
        {other_names_str}
    ],
    "essential_knowledge": [
        {essential_knowledge_str}
    ],
    "optional_knowledge": [
        {optional_knowledge_str}
    ]
}},

Given the student knowledge set:
{{
    {student_knowledge_str}
}}

Suggest 5 projects that would help the student bridge the gap between their current knowledge and those required for the job. Priortize essential knowledge first, then optional knowledge that is closely related to the student's existing skills.
Do not make up knowledges that are not in the provided job information.
Output in JSON format. Only output like a JSON file. Do not include any Markdown elements or code blocks. (for example ```json ... ```).

Output format:
{{
  "project_suggestions": [
    {{
      "title": "...",
      "description": "...",
      "knowledge_gain": [
        "a",
        "b",
        ...
      ],
      "reasoning": "..."
    }},
    ...
  ]
}}'''

        print(f"Generated prompt for Gemini: {prompt}")
        return prompt
    
    def suggest_project(self, job_info: Job, student_knowledge: List[str]) -> Dict:
        """
        Äá» xuáº¥t project dá»±a trÃªn job info vÃ  student knowledge
        
        Args:
            job_info: object Job
            student_knowledge: Danh sÃ¡ch knowledge mÃ  student Ä‘Ã£ cÃ³
            
        Returns:
            Dictionary chá»©a thÃ´ng tin project Ä‘Æ°á»£c Ä‘á» xuáº¥t
        """
        if not self.client:
            return {
                "error": "AI API is not configured."
            }
        
        if not job_info or not student_knowledge:
            return {
                "error": "Missing job information or student knowledge"
            }
        
        try:
            prompt = self._create_prompt(job_info, student_knowledge)
            response_text = self._call_llm(prompt)
            
            # Parse JSON response
            # Loáº¡i bá» markdown code blocks náº¿u cÃ³
            if "```json" in response_text:
                response_text = response_text.split("```json")[1].split("```")[0]
            elif "```" in response_text:
                response_text = response_text.split("```")[1].split("```")[0]
            
            project_data = json.loads(response_text.strip())
            project_data["source"] = "Generated by Google Gemini"
            project_data["job_name"] = job_info.name

            return project_data
        
        except Exception as e:
            print(f"Lá»—i khi gá»i AI API: {e}")
            return {
                "error": str(e)
            }
    
    def _call_llm(self, prompt: str) -> str:
        """
        Gá»i Google Gemini API vÃ  tráº£ vá» response
        
        Args:
            prompt: Prompt string
            
        Returns:
            Response text tá»« Gemini
        """
        try:
            if(self.client is None):
                raise Exception("Gemini client is not initialized.")
            response = self.client.models.generate_content(
                model=self.model_name, 
                contents=prompt,
                config=genai.types.GenerateContentConfig(
                    system_instruction=self.SYSTEM_INSTRUCTION,
                    temperature=0.7,
                    thinking_config=genai.types.ThinkingConfig(thinking_budget=8192),
                    max_output_tokens=8192
                ),
            )
            return response.text or ""  # null coalescing
        except Exception as e:
            print(f"âŒ Error calling Gemini API: {e}")
            return ""
    
    def _generate_fallback_project(self, learned_items: List[str],
                                  item_type: str,
                                  difficulty: str) -> Dict:
        """
        Táº¡o project fallback khi khÃ´ng cÃ³ AI API
        
        Args:
            learned_items: Danh sÃ¡ch items Ä‘Ã£ há»c
            item_type: Loáº¡i items
            difficulty: Äá»™ khÃ³
            
        Returns:
            Dictionary chá»©a thÃ´ng tin project fallback
        """
        items_str = ", ".join(learned_items[:5])
        
        return {
            "project_name": f"Practice Project: {items_str}",
            "description": f"A hands-on project to apply the {item_type} you've learned",
            "difficulty": difficulty,
            "estimated_time": "1-2 weeks",
            "objectives": [
                f"Apply learned {item_type} in practice",
                "Build a complete application",
                "Practice coding and problem solving"
            ],
            "technologies_used": learned_items,
            "implementation_steps": [
                {
                    "step": 1,
                    "title": "Design and Planning",
                    "description": "Draw diagrams, define requirements, and plan implementation"
                },
                {
                    "step": 2,
                    "title": "Develop Core Features",
                    "description": "Implement main features of the project"
                },
                {
                    "step": 3,
                    "title": "Testing and Debugging",
                    "description": "Thoroughly test and fix bugs"
                },
                {
                    "step": 4,
                    "title": "Finalize and Documentation",
                    "description": "Polish UI/UX, write documentation"
                }
            ],
            "learning_outcomes": [
                f"Master the learned {item_type}",
                "Gain real project experience",
                "Improve problem solving skills"
            ],
            "bonus_features": [
                "Add beautiful UI",
                "Deploy project to cloud",
                "Add unit tests"
            ],
            "source": "Fallback (no AI API)"
        }
    
    def format_project_for_display(self, project_data: Dict) -> str:
        """
        Format project data thÃ nh text dá»… Ä‘á»c
        
        Args:
            project_data: Dictionary chá»©a thÃ´ng tin project
            
        Returns:
            Formatted string
        """
        if "error" in project_data and "fallback" not in project_data:
            return f"âŒ Error: {project_data['error']}"
        
        # Náº¿u cÃ³ fallback, dÃ¹ng fallback
        if "fallback" in project_data:
            project_data = project_data["fallback"]
        
        output = []
        output.append("=" * 70)
        output.append("ğŸš€ PROJECT SUGGESTIONS")
        output.append("=" * 70)
        output.append("")
        
        # Xá»­ lÃ½ format má»›i vá»›i project_suggestions array
        if "project_suggestions" in project_data:
            suggestions = project_data["project_suggestions"]
            output.append(f"ğŸ“š Total: {len(suggestions)} projects suggested")
            output.append("")
            
            for idx, project in enumerate(suggestions, 1):
                output.append(f"{'â”€' * 70}")
                output.append(f"PROJECT {idx}: {project.get('title', 'N/A')}")
                output.append(f"{'â”€' * 70}")
                output.append("")
                
                output.append(f"ğŸ“ Description:")
                output.append(f"   {project.get('description', 'N/A')}")
                output.append("")
                
                if project.get('knowledge_gain'):
                    output.append(f"ğŸ’¡ Knowledge Applied ({len(project['knowledge_gain'])} items):")
                    for knowledge in project['knowledge_gain']:
                        output.append(f"   â€¢ {knowledge}")
                    output.append("")
                
                output.append(f"ğŸ¯ Reasoning:")
                output.append(f"   {project.get('reasoning', 'N/A')}")
                output.append("")
        
        else:
            # Format cÅ© (fallback)
            output.append(f"ğŸš€ PROJECT: {project_data.get('project_name', 'N/A')}")
            output.append("")
            
            output.append(f"ğŸ“ Description: {project_data.get('description', 'N/A')}")
            output.append(f"â±ï¸ Estimated Time: {project_data.get('estimated_time', 'N/A')}")
            output.append(f"ğŸ“Š Difficulty: {project_data.get('difficulty', 'N/A')}")
            output.append("")
            
            if project_data.get('objectives'):
                output.append("ğŸ¯ Objectives:")
                for obj in project_data['objectives']:
                    output.append(f"  â€¢ {obj}")
                output.append("")
            
            if project_data.get('technologies_used'):
                output.append("ğŸ”§ Technologies Used:")
                output.append(f"  {', '.join(project_data['technologies_used'])}")
                output.append("")
            
            if project_data.get('implementation_steps'):
                output.append("ğŸ“‹ Implementation Steps:")
                for step in project_data['implementation_steps']:
                    output.append(f"  {step['step']}. {step['title']}")
                    output.append(f"     {step['description']}")
                output.append("")
            
            if project_data.get('learning_outcomes'):
                output.append("ğŸ’¡ Learning Outcomes:")
                for outcome in project_data['learning_outcomes']:
                    output.append(f"  â€¢ {outcome}")
                output.append("")
            
            if project_data.get('bonus_features'):
                output.append("âœ¨ Bonus Features:")
                for feature in project_data['bonus_features']:
                    output.append(f"  â€¢ {feature}")
                output.append("")
        
        output.append(f"ğŸ¤– Source: {project_data.get('source', 'Generated by Google Gemini')}")
        output.append("=" * 70)
        
        return "\n".join(output)
